<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>GTFS Field Collector</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Barlow:wght@400;500;600;700;900&display=swap');

:root {
  --bg: #0d0d0d;
  --surface: #161616;
  --card: #1c1c1c;
  --border: #2a2a2a;
  --accent: #00e676;
  --accent-dim: rgba(0,230,118,0.10);
  --accent-border: rgba(0,230,118,0.3);
  --warn: #ffab00;
  --danger: #ff5252;
  --text: #f0f0f0;
  --muted: #666;
  --mono: 'DM Mono', monospace;
  --sans: 'Barlow', sans-serif;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  min-height: 100vh;
  padding-bottom: 5rem;
  background-image: radial-gradient(ellipse at 50% 0%, rgba(0,230,118,0.025) 0%, transparent 60%);
}

.topbar {
  position: sticky; top:0; z-index:100;
  background: rgba(13,13,13,0.96);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 0.85rem 1.2rem;
  display: flex; align-items: center; justify-content: space-between;
}
.topbar-title { font-family:var(--mono); font-size:0.65rem; color:var(--accent); letter-spacing:0.15em; text-transform:uppercase; }
.trip-timer { font-family:var(--mono); font-size:1.05rem; font-weight:500; display:none; }
.trip-timer.running { display:block; color:var(--accent); }

.nav-dots { display:flex; justify-content:center; gap:0.5rem; padding:0.75rem 0; }
.nav-dot { width:6px; height:6px; border-radius:50%; background:var(--border); transition:all 0.2s; }
.nav-dot.active { background:var(--accent); width:18px; border-radius:3px; }

.section { padding:1.2rem; display:none; }
.section.visible { display:block; }

.screen-label { font-family:var(--mono); font-size:0.6rem; color:var(--muted); letter-spacing:0.2em; text-transform:uppercase; margin-bottom:1.2rem; }
.big-label { font-size:1.6rem; font-weight:900; line-height:1.1; margin-bottom:0.35rem; }
.sub-label { font-size:0.82rem; color:var(--muted); margin-bottom:1.8rem; line-height:1.5; }

.field-group { margin-bottom:1.1rem; }
.field-label { font-family:var(--mono); font-size:0.58rem; color:var(--muted); letter-spacing:0.1em; text-transform:uppercase; margin-bottom:0.35rem; display:block; line-height:1.5; }

input[type="text"], select {
  width:100%; background:var(--card); border:1px solid var(--border); border-radius:10px;
  padding:0.85rem 1rem; color:var(--text); font-family:var(--sans); font-size:1rem;
  outline:none; transition:border-color 0.2s; -webkit-appearance:none;
}
input:focus, select:focus { border-color:var(--accent); }
input::placeholder { color:var(--muted); }

.btn {
  width:100%; padding:0.95rem; border-radius:12px; border:none;
  font-family:var(--sans); font-weight:700; font-size:0.95rem;
  cursor:pointer; transition:transform 0.1s; letter-spacing:0.02em;
  display:flex; align-items:center; justify-content:center; gap:0.5rem;
}
.btn:active { transform:scale(0.97); }
.btn-primary { background:var(--accent); color:#000; }
.btn-warn { background:var(--warn); color:#000; }
.btn-danger { background:var(--danger); color:#fff; }
.btn-ghost { background:var(--card); color:var(--text); border:1px solid var(--border); }
.btn-sm { padding:0.5rem 0.9rem; font-size:0.8rem; width:auto; }

.status-card {
  background:var(--accent-dim); border:1px solid var(--accent-border);
  border-radius:14px; padding:1rem 1.2rem; margin-bottom:1.2rem;
}
.status-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem; }
.status-key { font-family:var(--mono); font-size:0.58rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em; }
.status-val { font-family:var(--mono); font-size:0.82rem; font-weight:500; }
.status-val.hi { color:var(--accent); }

.stop-entry-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:1.2rem; margin-bottom:1.2rem; }
.stop-entry-title { font-size:0.65rem; font-family:var(--mono); color:var(--warn); letter-spacing:0.15em; text-transform:uppercase; margin-bottom:1rem; }

.gps-bar {
  display:flex; align-items:center; gap:0.6rem;
  padding:0.55rem 0.8rem; background:var(--accent-dim);
  border:1px solid var(--accent-border); border-radius:8px; margin-bottom:1rem;
  cursor:pointer; user-select:none;
}
.gps-dot { width:8px; height:8px; border-radius:50%; background:var(--warn); flex-shrink:0; }
.gps-dot.pulse { animation:pulse 1.5s infinite; }
.gps-dot.locked { background:var(--accent); animation:none; }
.gps-dot.failed { background:var(--danger); animation:none; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.8)} }
.gps-text { font-family:var(--mono); font-size:0.6rem; color:var(--accent); line-height:1.4; }

.dwell-row { display:flex; align-items:center; gap:0.8rem; margin-top:0.8rem; }
.dwell-label { font-family:var(--mono); font-size:0.58rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em; flex-shrink:0; }
.dwell-counter { display:flex; align-items:center; gap:0.4rem; background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:0.25rem 0.4rem; }
.dwell-btn { width:28px; height:28px; border-radius:6px; border:none; background:var(--border); color:var(--text); font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.dwell-btn:active { background:var(--accent); color:#000; }
.dwell-value { font-family:var(--mono); font-size:0.85rem; min-width:2.2rem; text-align:center; }

.stops-log-title { font-family:var(--mono); font-size:0.58rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.15em; margin-bottom:0.75rem; display:flex; justify-content:space-between; }

.stop-item { display:flex; align-items:flex-start; gap:0.8rem; padding:0.75rem 1rem; background:var(--card); border:1px solid var(--border); border-radius:10px; margin-bottom:0.5rem; animation:slideIn 0.2s ease; }
@keyframes slideIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.stop-seq { font-family:var(--mono); font-size:0.62rem; color:var(--accent); min-width:1.4rem; padding-top:0.15rem; }
.stop-details { flex:1; }
.stop-name-text { font-weight:600; font-size:0.88rem; margin-bottom:0.2rem; }
.stop-meta { font-family:var(--mono); font-size:0.58rem; color:var(--muted); line-height:1.6; }
.stop-del { background:none; border:none; color:var(--muted); font-size:0.9rem; cursor:pointer; padding:0.2rem; }
.stop-del:active { color:var(--danger); }

.action-bar { position:fixed; bottom:0; left:0; right:0; background:rgba(13,13,13,0.98); backdrop-filter:blur(12px); border-top:1px solid var(--border); padding:0.9rem 1.2rem; display:none; gap:0.8rem; z-index:100; }
.action-bar.visible { display:flex; }

.dl-card { background:var(--card); border:1px solid var(--accent-border); border-radius:14px; padding:1.2rem; margin-bottom:1rem; }
.dl-card-plain { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:1.2rem; margin-bottom:1rem; }
.dl-card-title { font-family:var(--mono); font-size:0.58rem; color:var(--accent); text-transform:uppercase; letter-spacing:0.15em; margin-bottom:0.8rem; }
.dl-card-title-plain { font-family:var(--mono); font-size:0.58rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.15em; margin-bottom:0.8rem; }
.file-row { display:flex; align-items:center; justify-content:space-between; padding:0.55rem 0; border-bottom:1px solid var(--border); }
.file-row:last-child { border-bottom:none; }
.file-name { font-family:var(--mono); font-size:0.78rem; }
.file-sz { font-family:var(--mono); font-size:0.62rem; color:var(--muted); }

.email-box { display:flex; align-items:center; gap:0.6rem; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:0.6rem 0.9rem; margin-bottom:1rem; }
.email-lbl { font-family:var(--mono); font-size:0.58rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em; flex-shrink:0; }
.email-addr { font-family:var(--mono); font-size:0.82rem; color:var(--accent); user-select:all; }

.preview-box { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:0.75rem; margin-bottom:0.8rem; overflow-x:auto; }
.preview-label { font-family:var(--mono); font-size:0.55rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.4rem; }
.preview-box pre { font-family:var(--mono); font-size:0.58rem; color:#aaa; white-space:pre; line-height:1.6; }

.summary-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; margin-bottom:1.4rem; }
.sum-tile { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:0.75rem 1rem; }
.sum-val { font-family:var(--mono); font-size:1.25rem; font-weight:500; color:var(--accent); margin-bottom:0.15rem; }
.sum-lbl { font-family:var(--mono); font-size:0.52rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em; }

.toast { position:fixed; bottom:5.5rem; left:50%; transform:translateX(-50%) translateY(16px); background:var(--accent); color:#000; font-weight:700; font-size:0.78rem; padding:0.55rem 1.1rem; border-radius:30px; opacity:0; transition:opacity 0.2s,transform 0.2s; pointer-events:none; white-space:nowrap; z-index:999; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* GPS FIX OVERLAY */
.gps-overlay { display:none; position:fixed; inset:0; z-index:500; background:rgba(0,0,0,0.93); padding:1.5rem; flex-direction:column; align-items:center; justify-content:center; }
.gps-overlay.visible { display:flex; }
.gps-overlay-card { background:var(--card); border:2px solid var(--danger); border-radius:16px; padding:1.5rem; max-width:380px; width:100%; }
.gps-overlay-title { font-size:1.1rem; font-weight:700; color:var(--danger); margin-bottom:0.4rem; }
.gps-overlay-sub { font-size:0.8rem; color:var(--muted); margin-bottom:1.2rem; line-height:1.6; }
.gps-steps { list-style:none; margin-bottom:1.2rem; }
.gps-steps li { font-size:0.82rem; color:var(--text); padding:0.55rem 0; border-bottom:1px solid var(--border); line-height:1.5; display:flex; gap:0.7rem; align-items:flex-start; }
.gps-steps li:last-child { border-bottom:none; }
.step-n { background:var(--danger); color:#fff; border-radius:50%; min-width:20px; height:20px; font-size:0.62rem; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:0.15rem; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-title">GTFS Field Collector</div>
  <div class="trip-timer" id="tripTimer">00:00:00</div>
</div>

<div class="nav-dots">
  <div class="nav-dot active" id="dot0"></div>
  <div class="nav-dot" id="dot1"></div>
  <div class="nav-dot" id="dot2"></div>
</div>

<!-- ‚îÄ‚îÄ SCREEN 0: SETUP ‚îÄ‚îÄ -->
<div class="section visible" id="screen-setup">
  <div class="screen-label">Step 1 of 3 ‚Äî Trip Setup</div>
  <div class="big-label">New Trip</div>
  <p class="sub-label">Fill in the bus details before you board. GPS captures your location automatically at each stop. When in doubt ‚Äî look at the front of the bus.</p>

  <div class="field-group">
    <label class="field-label">Route ID / Bus Number</label>
    <input type="text" id="routeId" placeholder="e.g. S9, PINK, 4A, AC-5">
  </div>

  <div class="field-group">
    <label class="field-label">Route Long Name ‚Äî where does this bus travel end to end?</label>
    <input type="text" id="routeName" placeholder="e.g. Howrah Station to Salt Lake Sector V">
  </div>

  <div class="field-group">
    <label class="field-label">Headsign ‚Äî what destination is written on the FRONT of the bus?</label>
    <input type="text" id="headsign" placeholder="e.g. Salt Lake Sector V via Esplanade, Park Street" oninput="updateDirectionLabels()">
  </div>

  <div class="field-group">
    <label class="field-label">Direction ‚Äî are you going TOWARD or AWAY FROM what the front of the bus says?</label>
    <select id="direction">
      <option value="0">Going TOWARD the destination on the front of the bus</option>
      <option value="1">Going AWAY FROM it (toward the other end of the route)</option>
    </select>
  </div>

  <div class="field-group">
    <label class="field-label">Service Days</label>
    <select id="serviceId">
      <option value="WEEKDAY">Weekday (Mon‚ÄìFri)</option>
      <option value="WEEKEND">Weekend (Sat‚ÄìSun)</option>
      <option value="DAILY">Daily (Every day)</option>
    </select>
  </div>

  <div class="field-group">
    <label class="field-label">Agency</label>
    <select id="agency">
      <option value="Private">Private</option>
      <option value="WBTC">WBTC</option>
      <option value="None">None / Don't Know</option>
    </select>
  </div>

  <div class="field-group">
    <label class="field-label">Collected By (your name)</label>
    <input type="text" id="collectedBy" placeholder="e.g. Neelabho">
  </div>

  <br>
  <button class="btn btn-primary" onclick="startTrip()">üöå &nbsp;On Bus ‚Äî Start Trip</button>
</div>

<!-- ‚îÄ‚îÄ SCREEN 1: RECORDING ‚îÄ‚îÄ -->
<div class="section" id="screen-record" style="padding-bottom:6rem">
  <div class="screen-label">Step 2 of 3 ‚Äî Recording</div>

  <div class="status-card">
    <div class="status-row"><div class="status-key">Route</div><div class="status-val hi" id="dispRoute">‚Äî</div></div>
    <div class="status-row"><div class="status-key">Trip ID</div><div class="status-val" id="dispTripId">‚Äî</div></div>
    <div class="status-row"><div class="status-key">Start Time</div><div class="status-val" id="dispStart">‚Äî</div></div>
    <div class="status-row"><div class="status-key">Stops Logged</div><div class="status-val hi" id="dispCount">0</div></div>
  </div>

  <div class="stop-entry-card">
    <div class="stop-entry-title">üìç Add Stop</div>

    <div class="gps-bar" onclick="retryGPS()" title="Tap to retry GPS">
      <div class="gps-dot pulse" id="gpsDot"></div>
      <div class="gps-text" id="gpsText">Waiting for location permission...</div>
    </div>

    <div class="field-group">
      <input type="text" id="stopName" placeholder="Stop name ‚Äî e.g. Esplanade, Gariahat crossing">
    </div>

    <div class="dwell-row">
      <div class="dwell-label">Dwell (sec)</div>
      <div class="dwell-counter">
        <button class="dwell-btn" onclick="chDwell(-15)">‚àí</button>
        <div class="dwell-value" id="dwellVal">30</div>
        <button class="dwell-btn" onclick="chDwell(15)">+</button>
      </div>
    </div>
  </div>

  <div class="stops-log-title">
    <span id="stopCountLbl">0 stops</span>
    <button class="btn btn-ghost btn-sm" onclick="undoLast()">‚Ü© Undo last</button>
  </div>
  <div id="stopsListEl"></div>
</div>

<!-- ‚îÄ‚îÄ SCREEN 2: DOWNLOAD ‚îÄ‚îÄ -->
<div class="section" id="screen-download">
  <div class="screen-label">Step 3 of 3 ‚Äî Download</div>
  <div class="big-label">Trip Complete</div>
  <p class="sub-label">Your data has been recorded. Download and send the file.</p>

  <div class="summary-grid" id="summaryGrid"></div>

  <div class="dl-card">
    <div class="dl-card-title">üì¶ Your Trip File</div>
    <p style="font-size:0.8rem;color:#aaa;line-height:1.6;margin-bottom:0.9rem">
      This single JSON file contains your entire trip. Download it and send it on WhatsApp.
      You can also email it to <a href="mailto:Kolkatabuses@gmail.com" style="color:var(--accent);text-decoration:none;">Kolkatabuses@gmail.com</a>
    </p>
    <div class="email-box">
      <span class="email-lbl">Email</span>
      <span class="email-addr">Kolkatabuses@gmail.com</span>
    </div>
    <button class="btn btn-primary" onclick="dlJSON()" style="margin-bottom:0.75rem">‚¨á &nbsp;Download Trip JSON</button>
    <button class="btn btn-ghost" onclick="emailJSON()" style="border-color:var(--accent-border);color:var(--accent)">‚úâ &nbsp;Email to Kolkatabuses@gmail.com</button>
  </div>

  <div class="dl-card-plain">
    <div class="dl-card-title-plain">Individual GTFS Files (advanced)</div>
    <div id="filesList"></div>
  </div>

  <div class="preview-box">
    <div class="preview-label">stop_times.txt preview</div>
    <pre id="prevStopTimes"></pre>
  </div>
  <div class="preview-box">
    <div class="preview-label">stops.txt preview</div>
    <pre id="prevStops"></pre>
  </div>

  <br>
  <button class="btn btn-ghost" onclick="newTrip()">‚Üê &nbsp;Record Another Trip</button>
</div>

<!-- ‚îÄ‚îÄ ACTION BAR ‚îÄ‚îÄ -->
<div class="action-bar" id="actionBar">
  <button class="btn btn-warn btn-sm" onclick="undoLast()" style="flex:1">‚Ü© Undo</button>
  <button class="btn btn-primary" onclick="addStop()" style="flex:2">+ &nbsp;Add Stop</button>
  <button class="btn btn-danger btn-sm" onclick="endTrip()" style="flex:1">‚ñ† End</button>
</div>

<!-- ‚îÄ‚îÄ GPS FIX OVERLAY ‚îÄ‚îÄ -->
<div class="gps-overlay" id="gpsOverlay">
  <div class="gps-overlay-card">
    <div class="gps-overlay-title">‚ö† Location Access Blocked</div>
    <div class="gps-overlay-sub">Your phone previously blocked location for this site. Follow these steps to fix it ‚Äî takes 30 seconds. You only need to do this once.</div>
    <ul class="gps-steps">
      <li><span class="step-n">1</span><span>Close this and open iPhone <strong>Settings</strong></span></li>
      <li><span class="step-n">2</span><span>Scroll down and tap <strong>Safari</strong></span></li>
      <li><span class="step-n">3</span><span>Tap <strong>Location</strong></span></li>
      <li><span class="step-n">4</span><span>Select <strong>Ask Next Time</strong></span></li>
      <li><span class="step-n">5</span><span>Come back here and tap <strong>On Bus ‚Äî Start Trip</strong> again. Tap <strong>Allow</strong> when Safari asks.</span></li>
    </ul>
    <button class="btn btn-danger" onclick="closeOverlay()" style="margin-bottom:0.75rem">Got it ‚Äî I'll fix it now</button>
    <button class="btn btn-ghost" onclick="closeOverlay()" style="font-size:0.82rem;color:var(--muted)">Continue without GPS (coords will be 0,0)</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let trip = {};
let timerInterval = null;
let timerSecs = 0;
let gps = null;
let gpsWatch = null;
let dwell = 30;

// ‚îÄ‚îÄ SCREEN NAV ‚îÄ‚îÄ
function showScreen(n) {
  document.querySelectorAll('.section').forEach((s,i) => s.classList.toggle('visible', i===n));
  document.querySelectorAll('.nav-dot').forEach((d,i) => d.classList.toggle('active', i===n));
  document.getElementById('actionBar').classList.toggle('visible', n===1);
}

// ‚îÄ‚îÄ GPS STATUS ‚îÄ‚îÄ
function setGPSStatus(state, msg) {
  const dot = document.getElementById('gpsDot');
  const text = document.getElementById('gpsText');
  text.textContent = msg;
  dot.className = 'gps-dot';
  if (state === 'locked') {
    dot.classList.add('locked');
    dot.style.background = 'var(--accent)';
  } else if (state === 'failed') {
    dot.classList.add('failed');
    dot.style.background = 'var(--danger)';
    dot.classList.add('pulse');
  } else {
    dot.style.background = 'var(--warn)';
    dot.classList.add('pulse');
  }
}

// ‚îÄ‚îÄ GPS REQUEST ‚îÄ‚îÄ
// Must be called inside a user-tap handler for Safari to show permission popup
function requestGPS(onDone) {
  if (!navigator.geolocation) {
    setGPSStatus('failed', 'GPS not available on this device');
    if (onDone) onDone(false);
    return;
  }
  setGPSStatus('acquiring', 'Requesting location ‚Äî tap Allow when your phone asks...');
  navigator.geolocation.getCurrentPosition(
    pos => {
      gps = { lat: pos.coords.latitude, lon: pos.coords.longitude, acc: Math.round(pos.coords.accuracy) };
      setGPSStatus('locked', gps.lat.toFixed(5) + ', ' + gps.lon.toFixed(5) + '  ¬±' + gps.acc + 'm');
      startGPSWatch();
      if (onDone) onDone(true);
    },
    err => {
      if (err.code === 1) {
        setGPSStatus('failed', '‚ö† Location blocked ‚Äî tap here for fix instructions');
        document.getElementById('gpsOverlay').classList.add('visible');
      } else if (err.code === 2) {
        setGPSStatus('failed', '‚ö† GPS signal not found ‚Äî try outdoors');
      } else {
        setGPSStatus('failed', '‚ö† GPS timed out ‚Äî tap the bar to retry');
      }
      if (onDone) onDone(false);
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function startGPSWatch() {
  if (gpsWatch !== null) return;
  gpsWatch = navigator.geolocation.watchPosition(
    p => {
      gps = { lat: p.coords.latitude, lon: p.coords.longitude, acc: Math.round(p.coords.accuracy) };
      setGPSStatus('locked', gps.lat.toFixed(5) + ', ' + gps.lon.toFixed(5) + '  ¬±' + gps.acc + 'm');
    },
    () => setGPSStatus('failed', '‚ö† GPS signal lost ‚Äî tap bar to retry'),
    { enableHighAccuracy: true, maximumAge: 4000 }
  );
}

function stopGPS() {
  if (gpsWatch !== null) { navigator.geolocation.clearWatch(gpsWatch); gpsWatch = null; }
  gps = null;
}

// Tap GPS bar to retry
function retryGPS() {
  if (gps) return;
  requestGPS(function(granted) {
    if (granted) toast('GPS locked ‚úì');
  });
}

function closeOverlay() {
  document.getElementById('gpsOverlay').classList.remove('visible');
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
function startTimer() {
  timerSecs = 0;
  var el = document.getElementById('tripTimer');
  el.classList.add('running');
  timerInterval = setInterval(function() {
    timerSecs++;
    var h = String(Math.floor(timerSecs/3600)).padStart(2,'0');
    var m = String(Math.floor((timerSecs%3600)/60)).padStart(2,'0');
    var s = String(timerSecs%60).padStart(2,'0');
    el.textContent = h+':'+m+':'+s;
  }, 1000);
}
function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById('tripTimer').classList.remove('running');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function nowHMS() {
  var n = new Date();
  return String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0')+':'+String(n.getSeconds()).padStart(2,'0');
}
function addSecs(t, s) {
  var parts = t.split(':').map(Number);
  var tot = parts[0]*3600 + parts[1]*60 + parts[2] + s;
  return String(Math.floor(tot/3600)).padStart(2,'0')+':'+String(Math.floor((tot%3600)/60)).padStart(2,'0')+':'+String(tot%60).padStart(2,'0');
}
function makeTripId(route, time, dir) {
  return route+'-'+time.replace(/:/g,'').slice(0,4)+'-'+(dir==='0'?'OUT':'RTN');
}
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2500);
}
function chDwell(d) { dwell = Math.max(0, dwell+d); document.getElementById('dwellVal').textContent = dwell; }

// ‚îÄ‚îÄ DIRECTION LABELS ‚îÄ‚îÄ
function updateDirectionLabels() {
  var headsign = document.getElementById('headsign').value.trim();
  var sel = document.getElementById('direction');
  var dest = headsign || 'the destination on the front of the bus';
  var shortDest = dest.split(' via ')[0].split(' - ').pop().trim();
  var label = shortDest.length > 22 ? shortDest.slice(0,22)+'‚Ä¶' : shortDest;
  sel.options[0].text = '‚úì Going TOWARD "' + label + '" ‚Äî this is my direction';
  sel.options[1].text = '‚úó Going AWAY from "' + label + '" ‚Äî toward the other end';
}

// ‚îÄ‚îÄ START TRIP ‚îÄ‚îÄ
function startTrip() {
  var routeId = document.getElementById('routeId').value.trim().toUpperCase();
  var headsign = document.getElementById('headsign').value.trim();
  if (!routeId) { toast('Enter a Route ID first'); return; }
  if (!headsign) { toast('Enter the headsign (front of bus)'); return; }
  var t = nowHMS();
  var dir = document.getElementById('direction').value;
  trip = {
    routeId: routeId,
    headsign: headsign,
    routeName: document.getElementById('routeName').value.trim() || routeId,
    direction: dir,
    serviceId: document.getElementById('serviceId').value,
    agency: document.getElementById('agency').value,
    collectedBy: document.getElementById('collectedBy').value.trim() || 'Unknown',
    collectedOn: new Date().toISOString().slice(0,10),
    tripId: makeTripId(routeId, t, dir),
    startTime: new Date(),
    startTimeStr: t,
    stops: []
  };
  document.getElementById('dispRoute').textContent = routeId + ' ‚Üí ' + headsign;
  document.getElementById('dispTripId').textContent = trip.tripId;
  document.getElementById('dispStart').textContent = t;
  document.getElementById('dispCount').textContent = '0';
  showScreen(1);
  startTimer();
  // Request GPS here ‚Äî inside user tap handler so Safari shows the permission popup
  requestGPS(function(granted) {
    if (granted) toast('GPS locked ‚úì ‚Äî Add your first stop!');
    else toast('‚ö† No GPS ‚Äî see instructions above');
  });
}

// ‚îÄ‚îÄ ADD STOP ‚îÄ‚îÄ
function addStop() {
  var name = document.getElementById('stopName').value.trim();
  if (!name) { toast('Enter stop name first'); return; }
  if (!gps) {
    if (!confirm('‚ö† GPS not locked yet.\n\nThis stop will have no coordinates (0,0).\n\nAdd anyway?')) return;
  }
  var arr = nowHMS();
  var dep = addSecs(arr, dwell);
  var seq = trip.stops.length + 1;
  trip.stops.push({
    seq: seq,
    name: name,
    stopId: trip.routeId + '-S' + String(seq).padStart(3,'0'),
    lat: gps ? gps.lat : 0,
    lon: gps ? gps.lon : 0,
    arrivalTime: arr,
    departureTime: dep,
    dwell: dwell,
    verified: gps !== null
  });
  document.getElementById('dispCount').textContent = trip.stops.length;
  document.getElementById('stopCountLbl').textContent = trip.stops.length + (trip.stops.length !== 1 ? ' stops' : ' stop');
  renderStops();
  document.getElementById('stopName').value = '';
  toast('Stop ' + seq + ' logged ‚úì');
}

// ‚îÄ‚îÄ RENDER STOPS ‚îÄ‚îÄ
function renderStops() {
  var el = document.getElementById('stopsListEl');
  el.innerHTML = '';
  var reversed = trip.stops.slice().reverse();
  reversed.forEach(function(s) {
    var d = document.createElement('div');
    d.className = 'stop-item';
    d.innerHTML =
      '<div class="stop-seq">' + s.seq + '</div>' +
      '<div class="stop-details">' +
        '<div class="stop-name-text">' + s.name + '</div>' +
        '<div class="stop-meta">' +
          s.arrivalTime + ' ‚Üí ' + s.departureTime + ' &nbsp;¬∑&nbsp; ' +
          (s.lat !== 0 ? s.lat.toFixed(5) + ', ' + s.lon.toFixed(5) : '‚ö† no GPS') +
          ' &nbsp;¬∑&nbsp; ' + (s.verified ? '‚úì GPS' : '‚ö† unverified') +
        '</div>' +
      '</div>' +
      '<button class="stop-del" onclick="delStop(' + s.seq + ')">‚úï</button>';
    el.appendChild(d);
  });
}

function delStop(seq) {
  trip.stops = trip.stops.filter(function(s){ return s.seq !== seq; });
  trip.stops.forEach(function(s,i){
    s.seq = i+1;
    s.stopId = trip.routeId + '-S' + String(i+1).padStart(3,'0');
  });
  document.getElementById('dispCount').textContent = trip.stops.length;
  document.getElementById('stopCountLbl').textContent = trip.stops.length + (trip.stops.length !== 1 ? ' stops' : ' stop');
  renderStops();
  toast('Stop removed');
}

function undoLast() {
  if (!trip.stops.length) { toast('No stops to undo'); return; }
  trip.stops.pop();
  document.getElementById('dispCount').textContent = trip.stops.length;
  document.getElementById('stopCountLbl').textContent = trip.stops.length + (trip.stops.length !== 1 ? ' stops' : ' stop');
  renderStops();
  toast('Last stop undone');
}

// ‚îÄ‚îÄ END TRIP ‚îÄ‚îÄ
function endTrip() {
  if (trip.stops.length < 2) { toast('Add at least 2 stops first'); return; }
  stopTimer(); stopGPS();
  buildDownloadScreen();
  showScreen(2);
}

// ‚îÄ‚îÄ GTFS BUILDERS ‚îÄ‚îÄ
function buildAgency() {
  var name = trip.agency === 'WBTC' ? 'West Bengal Transport Corporation' : trip.agency === 'Private' ? 'Private Operator' : 'Unknown';
  var url = trip.agency === 'WBTC' ? 'https://www.wbtc.co.in' : '';
  return 'agency_id,agency_name,agency_url,agency_timezone\n' + trip.agency + ',' + name + ',' + url + ',Asia/Kolkata\n';
}
function buildRoutes() {
  return 'route_id,agency_id,route_short_name,route_long_name,route_type\n' + trip.routeId + ',' + trip.agency + ',' + trip.routeId + ',' + trip.routeName + ',3\n';
}
function buildStops() {
  var c = 'stop_id,stop_name,stop_lat,stop_lon,verified\n';
  trip.stops.forEach(function(s){ c += s.stopId + ',' + s.name + ',' + s.lat + ',' + s.lon + ',' + s.verified + '\n'; });
  return c;
}
function buildTrips() {
  return 'route_id,service_id,trip_id,direction_id,trip_headsign\n' + trip.routeId + ',' + trip.serviceId + ',' + trip.tripId + ',' + trip.direction + ',' + trip.headsign + '\n';
}
function buildStopTimes() {
  var c = 'trip_id,arrival_time,departure_time,stop_id,stop_sequence\n';
  trip.stops.forEach(function(s){ c += trip.tripId + ',' + s.arrivalTime + ',' + s.departureTime + ',' + s.stopId + ',' + s.seq + '\n'; });
  return c;
}
function buildCalendar() {
  var today = new Date();
  var future = new Date(today); future.setFullYear(future.getFullYear()+1);
  function fmt(d){ return d.toISOString().slice(0,10).replace(/-/g,''); }
  var sd = fmt(today); var ed = fmt(future);
  var rows = {
    WEEKDAY: 'WEEKDAY,1,1,1,1,1,0,0,' + sd + ',' + ed,
    WEEKEND: 'WEEKEND,0,0,0,0,0,1,1,' + sd + ',' + ed,
    DAILY:   'DAILY,1,1,1,1,1,1,1,' + sd + ',' + ed
  };
  return 'service_id,monday,tuesday,wednesday,thursday,friday,saturday,sunday,start_date,end_date\n' + (rows[trip.serviceId] || rows.WEEKDAY) + '\n';
}

var FILES = [
  {name:'agency.txt',    fn:buildAgency},
  {name:'routes.txt',    fn:buildRoutes},
  {name:'stops.txt',     fn:buildStops},
  {name:'trips.txt',     fn:buildTrips},
  {name:'stop_times.txt',fn:buildStopTimes},
  {name:'calendar.txt',  fn:buildCalendar}
];

// ‚îÄ‚îÄ JSON ‚îÄ‚îÄ
function buildJSON() {
  return JSON.stringify({
    routeId: trip.routeId,
    routeName: trip.routeName,
    direction: trip.direction,
    serviceId: trip.serviceId,
    headsign: trip.headsign,
    agency: trip.agency,
    tripId: trip.tripId,
    startTimeStr: trip.startTimeStr,
    collectedBy: trip.collectedBy,
    collectedOn: trip.collectedOn,
    stops: trip.stops.map(function(s){
      return { seq:s.seq, stopId:s.stopId, name:s.name, lat:s.lat, lon:s.lon, arrivalTime:s.arrivalTime, departureTime:s.departureTime, verified:s.verified };
    })
  }, null, 2);
}
function jsonFilename() {
  return 'trip_' + trip.routeId + '_' + trip.collectedBy.replace(/\s+/g,'_').toLowerCase() + '_' + trip.collectedOn + '.json';
}

// ‚îÄ‚îÄ DOWNLOAD SCREEN ‚îÄ‚îÄ
function buildDownloadScreen() {
  var dur = Math.round((new Date() - trip.startTime) / 60000);
  document.getElementById('summaryGrid').innerHTML =
    '<div class="sum-tile"><div class="sum-val">' + trip.routeId + '</div><div class="sum-lbl">Route</div></div>' +
    '<div class="sum-tile"><div class="sum-val">' + trip.stops.length + '</div><div class="sum-lbl">Stops</div></div>' +
    '<div class="sum-tile"><div class="sum-val">' + dur + 'm</div><div class="sum-lbl">Duration</div></div>' +
    '<div class="sum-tile"><div class="sum-val">' + trip.stops.filter(function(s){return s.verified;}).length + '</div><div class="sum-lbl">GPS Verified</div></div>';

  var fl = document.getElementById('filesList');
  fl.innerHTML = '';
  FILES.forEach(function(f) {
    var content = f.fn();
    var sz = new Blob([content]).size;
    var label = sz < 1024 ? sz + ' B' : (sz/1024).toFixed(1) + ' KB';
    var row = document.createElement('div');
    row.className = 'file-row';
    row.innerHTML = '<div class="file-name">' + f.name + '</div><div style="display:flex;align-items:center;gap:0.7rem"><div class="file-sz">' + label + '</div><button class="btn btn-ghost btn-sm" onclick="dlSingle(\'' + f.name + '\')">‚Üì</button></div>';
    fl.appendChild(row);
  });
  document.getElementById('prevStopTimes').textContent = buildStopTimes();
  document.getElementById('prevStops').textContent = buildStops();
}

// ‚îÄ‚îÄ DOWNLOAD / EMAIL ‚îÄ‚îÄ
function dlFile(name, content, type) {
  var a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], {type: type || 'text/csv;charset=utf-8;'}));
  a.download = name;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function dlJSON() {
  dlFile(jsonFilename(), buildJSON(), 'application/json');
  toast('JSON downloaded ‚Äî send on WhatsApp!');
}
function emailJSON() {
  var subject = encodeURIComponent('Bus Trip Data ‚Äî ' + trip.routeId + ' ‚Äî ' + trip.collectedOn);
  var body = encodeURIComponent(
    'Hi,\n\nPlease find my bus trip data attached.\n\n' +
    'Route: ' + trip.routeId + ' ‚Äî ' + trip.routeName + '\n' +
    'Collected by: ' + trip.collectedBy + '\n' +
    'Date: ' + trip.collectedOn + '\n' +
    'Stops: ' + trip.stops.length + '\n' +
    'Trip ID: ' + trip.tripId + '\n\n' +
    'I have downloaded the JSON file and will attach it to this email.\n\n' +
    'Regards,\n' + trip.collectedBy
  );
  dlFile(jsonFilename(), buildJSON(), 'application/json');
  setTimeout(function() {
    window.location.href = 'mailto:Kolkatabuses@gmail.com?subject=' + subject + '&body=' + body;
    toast('File downloaded ‚Äî attach it to the email!');
  }, 600);
}
function dlSingle(name) {
  var f = FILES.find(function(x){ return x.name === name; });
  if (f) { dlFile(name, f.fn()); toast(name + ' downloaded'); }
}
function downloadAll() {
  var i = 0;
  function next() {
    if (i >= FILES.length) { toast('All 6 files downloaded!'); return; }
    var f = FILES[i++];
    dlFile(f.name, f.fn());
    setTimeout(next, 300);
  }
  next();
}

// ‚îÄ‚îÄ NEW TRIP ‚îÄ‚îÄ
function newTrip() {
  stopGPS();
  trip = {}; timerSecs = 0; dwell = 30; gps = null;
  document.getElementById('tripTimer').textContent = '00:00:00';
  document.getElementById('stopsListEl').innerHTML = '';
  document.getElementById('stopCountLbl').textContent = '0 stops';
  document.getElementById('dwellVal').textContent = '30';
  document.getElementById('collectedBy').value = '';
  document.getElementById('gpsOverlay').classList.remove('visible');
  setGPSStatus('waiting', 'Waiting for location permission...');
  showScreen(0);
}
</script>
</body>
</html>
